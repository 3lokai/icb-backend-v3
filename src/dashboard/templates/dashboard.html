<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Scraping Operations Dashboard</title>
    <style>
        .user-navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        .role-admin { background: rgba(220, 53, 69, 0.8); }
        .role-operator { background: rgba(255, 193, 7, 0.8); }
        .role-user { background: rgba(0, 123, 255, 0.8); }
        .role-viewer { background: rgba(40, 167, 69, 0.8); }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .health-excellent { color: #28a745; }
        .health-good { color: #17a2b8; }
        .health-warning { color: #ffc107; }
        .health-critical { color: #dc3545; }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .alert-item {
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8d7da;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }
        
        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .metric-card {
                margin-bottom: 15px;
                padding: 15px;
            }
            .metric-value {
                font-size: 2rem;
            }
            .table-responsive {
                font-size: 0.9rem;
            }
            .card-body {
                padding: 15px;
            }
            .progress {
                height: 15px;
            }
            .navbar-brand {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 576px) {
            .metric-value {
                font-size: 1.5rem;
            }
            .metric-card {
                padding: 10px;
            }
            .table-responsive {
                font-size: 0.8rem;
            }
            .card-header h5 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- User Navigation Bar -->
    <div class="user-navbar">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0"><i class="fas fa-coffee"></i> Operations Dashboard</h4>
                </div>
                <div class="col-md-6 text-end">
                    <div class="user-info">
                        <div>
                            <i class="fas fa-user"></i> {{ user.email if user else 'Guest' }}
                            <span class="user-role role-{{ user.role if user else 'user' }}">
                                {{ user.role if user else 'user' }}
                            </span>
                        </div>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- System Health Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat"></i> System Health Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card text-center">
                                    <div class="metric-value" id="healthScore">--</div>
                                    <div class="metric-label">Health Score</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card text-center">
                                    <div class="metric-value" id="totalRoasters">--</div>
                                    <div class="metric-label">Total Roasters</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card text-center">
                                    <div class="metric-value" id="totalCoffees">--</div>
                                    <div class="metric-label">Total Coffees</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card text-center">
                                    <div class="metric-value" id="activeAlerts">--</div>
                                    <div class="metric-label">Active Alerts</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Distribution & Roaster Performance -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Platform Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="platformChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Performance Metrics</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roaster Performance -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-industry"></i> Roaster Performance (Last 7 Days)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Roaster</th>
                                        <th>Total Runs</th>
                                        <th>Success Rate</th>
                                        <th>Avg Duration</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="roasterPerformanceTable">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Alerts -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Active Alerts</h5>
                    </div>
                    <div class="card-body">
                        <div id="activeAlerts">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Metrics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Product Discovery</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4 text-center">
                                <h4 id="totalProducts">--</h4>
                                <small>Total Products</small>
                            </div>
                            <div class="col-4 text-center">
                                <h4 id="newProducts7d">--</h4>
                                <small>New (7d)</small>
                            </div>
                            <div class="col-4 text-center">
                                <h4 id="updatedProducts7d">--</h4>
                                <small>Updated (7d)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Data Quality</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <h4 id="avgConfidence">--</h4>
                                <small>Avg Confidence</small>
                            </div>
                            <div class="col-6 text-center">
                                <h4 id="priceUpdates30d">--</h4>
                                <small>Price Updates (30d)</small>
                                <br><small class="text-muted">Weekly cadence</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> Pipeline Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Running Jobs</h6>
                                    <h4 id="runningJobs">--</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Last Run</h6>
                                    <small id="lastRunTime">--</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Queue Size</h6>
                                    <h4 id="queueSize">--</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Processing Rate</h6>
                                    <h4 id="processingRate">--</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget & Cost Monitoring -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-dollar-sign"></i> Budget & Cost Monitoring</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Budget Usage</h6>
                                    <div class="progress">
                                        <div class="progress-bar" id="budgetProgress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="budgetText">0%</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Error Rate</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-danger" id="errorProgress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="errorText">0%</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Success Rate</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" id="successProgress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="successText">0%</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>System Status</h6>
                                    <div id="systemStatus">
                                        <span class="status-indicator status-healthy"></span>
                                        <span>Healthy</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scraping Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play-circle"></i> Scraping Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Trigger Scraping Jobs</h6>
                                <div class="form-group mb-3">
                                    <label for="jobType">Job Type:</label>
                                    <select id="jobType" class="form-control">
                                        <option value="full_refresh">Full Refresh</option>
                                        <option value="price_only">Price Only</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="roasterSelect">Roaster (Optional):</label>
                                    <select id="roasterSelect" class="form-control">
                                        <option value="">All Roasters</option>
                                    </select>
                                </div>
                                <button id="triggerScraping" class="btn btn-primary">
                                    <i class="fas fa-play"></i> Trigger Scraping
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h6>Queue Status</h6>
                                <div id="queueStatus">
                                    <p>Pending: <span id="pendingJobs">--</span></p>
                                    <p>Running: <span id="runningJobs">--</span></p>
                                    <p>Completed: <span id="completedJobs">--</span></p>
                                    <p>Failed: <span id="failedJobs">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roaster Management -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-coffee"></i> Roaster Management</h5>
                        <button id="addRoasterBtn" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> Add Roaster
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="roastersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Platform</th>
                                        <th>Cadence</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="roastersTableBody">
                                    <!-- Roasters will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let platformChart, performanceChart;
        let refreshInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            refreshInterval = setInterval(loadDashboardData, 30000);
        });

        function initializeCharts() {
            // Platform Distribution Chart
            const platformCtx = document.getElementById('platformChart').getContext('2d');
            platformChart = new Chart(platformCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Success Rate',
                        data: [],
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function loadDashboardData() {
            try {
                // Load overview data
                const overviewResponse = await fetch('/api/dashboard/overview');
                const overviewData = await overviewResponse.json();
                updateOverview(overviewData);

                // Load roasters data
                const roastersResponse = await fetch('/api/dashboard/roasters');
                const roastersData = await roastersResponse.json();
                updateRoastersData(roastersData);

                // Load budget data
                const budgetResponse = await fetch('/api/dashboard/budget');
                const budgetData = await budgetResponse.json();
                updateBudgetData(budgetData);

                // Load business metrics
                const businessResponse = await fetch('/api/dashboard/business-metrics');
                const businessData = await businessResponse.json();
                updateBusinessMetrics(businessData);

                // Load pipeline status
                const pipelineResponse = await fetch('/api/dashboard/pipeline-status');
                const pipelineData = await pipelineResponse.json();
                updatePipelineStatus(pipelineData);

                // Update last updated timestamp
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        function updateOverview(data) {
            if (data.system_health) {
                document.getElementById('healthScore').textContent = data.system_health.score;
                document.getElementById('healthScore').className = `metric-value health-${data.system_health.status}`;
            }

            if (data.platform_summary) {
                document.getElementById('totalRoasters').textContent = data.platform_summary.total_roasters || 0;
                document.getElementById('totalCoffees').textContent = data.platform_summary.total_coffees || 0;
            }

            if (data.active_alerts) {
                document.getElementById('activeAlerts').textContent = data.active_alerts.length;
            }
        }

        function updateRoastersData(data) {
            if (data.distribution && platformChart) {
                const labels = data.distribution.map(item => item.platform || 'Unknown');
                const values = data.distribution.map(item => item.roaster_count || 0);
                
                platformChart.data.labels = labels;
                platformChart.data.datasets[0].data = values;
                platformChart.update();
            }

            if (data.recent_activity) {
                const activityHtml = data.recent_activity.map(activity => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${activity.description || 'Activity'}</span>
                        <small class="text-muted">${new Date(activity.timestamp).toLocaleTimeString()}</small>
                    </div>
                `).join('');
                
                document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">No recent activity</p>';
            }
        }

        function updateBudgetData(data) {
            if (data.operations_data && data.operations_data.system_health) {
                const health = data.operations_data.system_health;
                
                // Update budget usage
                const budgetUsage = health.budget_usage || 0;
                document.getElementById('budgetProgress').style.width = `${budgetUsage}%`;
                document.getElementById('budgetText').textContent = `${budgetUsage.toFixed(1)}%`;

                // Update error rate
                const errorRate = health.error_rate || 0;
                document.getElementById('errorProgress').style.width = `${errorRate * 100}%`;
                document.getElementById('errorText').textContent = `${(errorRate * 100).toFixed(1)}%`;

                // Update success rate
                const successRate = 100 - (errorRate * 100);
                document.getElementById('successProgress').style.width = `${successRate}%`;
                document.getElementById('successText').textContent = `${successRate.toFixed(1)}%`;

                // Update system status
                const statusElement = document.getElementById('systemStatus');
                const statusIndicator = statusElement.querySelector('.status-indicator');
                const statusText = statusElement.querySelector('span:last-child');
                
                statusIndicator.className = `status-indicator status-${health.status}`;
                statusText.textContent = health.status.charAt(0).toUpperCase() + health.status.slice(1);
            }

            if (data.operations_data && data.operations_data.active_alerts) {
                const alertsHtml = data.operations_data.active_alerts.map(alert => `
                    <div class="alert-item">
                        <strong>${alert.type || 'Alert'}</strong><br>
                        <small>${alert.message || 'No message'}</small>
                    </div>
                `).join('');
                
                document.getElementById('activeAlerts').innerHTML = alertsHtml || '<p class="text-muted">No active alerts</p>';
            }
        }

        function updateBusinessMetrics(data) {
            if (data.product_metrics) {
                document.getElementById('totalProducts').textContent = data.product_metrics.total_products || 0;
                document.getElementById('newProducts7d').textContent = data.product_metrics.new_products_7d || 0;
                document.getElementById('updatedProducts7d').textContent = data.product_metrics.updated_products_7d || 0;
            }

            if (data.quality_metrics) {
                document.getElementById('avgConfidence').textContent = data.quality_metrics.avg_confidence_score || '0.00';
            }

            if (data.price_metrics) {
                document.getElementById('priceUpdates30d').textContent = data.price_metrics.price_updates_30d || 0;
            }

            // Update roaster performance table
            if (data.roaster_metrics && data.roaster_metrics.roaster_performance) {
                updateRoasterPerformanceTable(data.roaster_metrics.roaster_performance);
            }
        }

        function updateRoasterPerformanceTable(roasterData) {
            const tableBody = document.getElementById('roasterPerformanceTable');
            
            if (!roasterData || roasterData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No roaster performance data available</td></tr>';
                return;
            }

            const rows = roasterData.map(roaster => {
                const successRate = roaster.success_rate || 0;
                const statusClass = successRate >= 90 ? 'success' : successRate >= 70 ? 'warning' : 'danger';
                const statusText = successRate >= 90 ? 'Excellent' : successRate >= 70 ? 'Good' : 'Needs Attention';
                
                return `
                    <tr>
                        <td><strong>${roaster.roaster_name || 'Unknown'}</strong></td>
                        <td>${roaster.total_runs || 0}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-${statusClass}" role="progressbar" 
                                     style="width: ${successRate}%" aria-valuenow="${successRate}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${successRate}%
                                </div>
                            </div>
                        </td>
                        <td>${roaster.avg_duration_seconds ? Math.round(roaster.avg_duration_seconds) + 's' : 'N/A'}</td>
                        <td>
                            <span class="badge bg-${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        function updatePipelineStatus(data) {
            if (data.pipeline_status) {
                document.getElementById('runningJobs').textContent = data.pipeline_status.running_jobs || 0;
                
                if (data.pipeline_status.last_run_time) {
                    const lastRun = new Date(data.pipeline_status.last_run_time);
                    document.getElementById('lastRunTime').textContent = lastRun.toLocaleString();
                } else {
                    document.getElementById('lastRunTime').textContent = 'No recent runs';
                }
            }

            if (data.job_queue) {
                document.getElementById('queueSize').textContent = data.job_queue.queue_size || 0;
                document.getElementById('processingRate').textContent = data.job_queue.processing_rate || 0;
            }
        }

        function showError(message) {
            console.error(message);
            // You could add a toast notification here
        }

        // =============================================================================
        // SCRAPING CONTROLS
        // =============================================================================
        
        async function triggerScraping() {
            const jobType = document.getElementById('jobType').value;
            const roasterId = document.getElementById('roasterSelect').value;
            
            try {
                const response = await fetch('/api/dashboard/trigger-scraping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_type: jobType,
                        roaster_id: roasterId || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Scraping job triggered successfully: ${result.message}`);
                    // Refresh queue status
                    loadQueueStatus();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error triggering scraping:', error);
                alert('Error triggering scraping job');
            }
        }

        async function loadQueueStatus() {
            try {
                const response = await fetch('/api/dashboard/queue-status');
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('pendingJobs').textContent = data.queue_status.pending_jobs;
                    document.getElementById('runningJobs').textContent = data.queue_status.running_jobs;
                    document.getElementById('completedJobs').textContent = data.queue_status.completed_jobs;
                    document.getElementById('failedJobs').textContent = data.queue_status.failed_jobs;
                }
            } catch (error) {
                console.error('Error loading queue status:', error);
            }
        }

        async function loadRoasters() {
            try {
                const response = await fetch('/api/dashboard/roasters');
                const data = await response.json();
                
                if (response.ok) {
                    // Populate roaster select dropdown
                    const roasterSelect = document.getElementById('roasterSelect');
                    roasterSelect.innerHTML = '<option value="">All Roasters</option>';
                    
                    data.roasters.forEach(roaster => {
                        const option = document.createElement('option');
                        option.value = roaster.roaster_id;
                        option.textContent = roaster.name;
                        roasterSelect.appendChild(option);
                    });
                    
                    // Populate roasters table
                    updateRoastersTable(data.roasters);
                }
            } catch (error) {
                console.error('Error loading roasters:', error);
            }
        }

        function updateRoastersTable(roasters) {
            const tableBody = document.getElementById('roastersTableBody');
            
            const rows = roasters.map(roaster => {
                const statusClass = roaster.enabled ? 'success' : 'secondary';
                const statusText = roaster.enabled ? 'Active' : 'Disabled';
                
                return `
                    <tr>
                        <td>${roaster.name}</td>
                        <td>${roaster.platform}</td>
                        <td>${roaster.cadence}</td>
                        <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editRoaster('${roaster.roaster_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRoaster('${roaster.roaster_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = rows;
        }

        function editRoaster(roasterId) {
            // Implement roaster editing functionality
            alert(`Edit roaster: ${roasterId}`);
        }

        function deleteRoaster(roasterId) {
            if (confirm(`Are you sure you want to delete roaster ${roasterId}?`)) {
                // Implement roaster deletion
                alert(`Delete roaster: ${roasterId}`);
            }
        }

        function addRoaster() {
            // Implement roaster addition functionality
            alert('Add new roaster functionality');
        }

        // Event listeners
        document.getElementById('triggerScraping').addEventListener('click', triggerScraping);
        document.getElementById('addRoasterBtn').addEventListener('click', addRoaster);

        // Load initial data
        loadQueueStatus();
        loadRoasters();

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
